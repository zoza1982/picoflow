name: Cross-Compilation Test

on:
  pull_request:
    paths:
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.cargo/**'
      - 'scripts/**'
      - 'Dockerfile.build'
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.cargo/**'
      - 'scripts/**'
      - 'Dockerfile.build'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  check-toolchains:
    name: Verify Cross-Compilation Setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Verify .cargo/config.toml
        run: |
          if [ ! -f .cargo/config.toml ]; then
            echo "Error: .cargo/config.toml not found"
            exit 1
          fi
          echo ".cargo/config.toml exists"
          cat .cargo/config.toml

      - name: Verify build scripts
        run: |
          for script in build-all.sh build-release.sh package-release.sh docker-build.sh; do
            if [ ! -x scripts/$script ]; then
              echo "Error: scripts/$script not executable"
              exit 1
            fi
            echo "✓ scripts/$script is executable"
          done

      - name: Verify Dockerfile.build
        run: |
          if [ ! -f Dockerfile.build ]; then
            echo "Error: Dockerfile.build not found"
            exit 1
          fi
          echo "✓ Dockerfile.build exists"

  build-native:
    name: Build Native (${{ matrix.target }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: armv7-unknown-linux-gnueabihf
            platform: arm32
          - target: aarch64-unknown-linux-gnu
            platform: arm64
          - target: x86_64-unknown-linux-gnu
            platform: x86_64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-linux-gnueabihf gcc-aarch64-linux-gnu

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Build
        run: |
          cargo build --release --target ${{ matrix.target }}

      - name: Check binary size
        run: |
          BINARY="target/${{ matrix.target }}/release/picoflow"
          if [ ! -f "$BINARY" ]; then
            echo "Error: Binary not found at $BINARY"
            exit 1
          fi

          SIZE=$(stat -c%s "$BINARY")
          SIZE_MB=$(echo "scale=2; $SIZE / 1024 / 1024" | bc)
          echo "Binary size: ${SIZE_MB}MB"

          MAX_SIZE=$((10 * 1024 * 1024))  # 10MB
          if [ $SIZE -gt $MAX_SIZE ]; then
            echo "::error::Binary size ${SIZE_MB}MB exceeds 10MB target"
            exit 1
          fi

      - name: Verify binary format
        run: |
          BINARY="target/${{ matrix.target }}/release/picoflow"
          file "$BINARY"

  build-docker:
    name: Build with Docker (${{ matrix.platform }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform: [arm32, arm64, x86_64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -f Dockerfile.build -t picoflow-builder .

      - name: Build with Docker
        run: |
          docker run --rm \
            -v $(pwd):/workspace \
            picoflow-builder \
            ${{ matrix.platform }}

      - name: Verify output
        run: |
          BINARY="target/release-binaries/picoflow-${{ matrix.platform }}"
          if [ ! -f "$BINARY" ]; then
            echo "Error: Binary not found at $BINARY"
            exit 1
          fi

          SIZE=$(stat -c%s "$BINARY")
          SIZE_MB=$(echo "scale=2; $SIZE / 1024 / 1024" | bc)
          echo "Binary size: ${SIZE_MB}MB"

  test-scripts:
    name: Test Build Scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc

      - name: Add Rust targets
        run: |
          rustup target add armv7-unknown-linux-gnueabihf
          rustup target add aarch64-unknown-linux-gnu
          rustup target add x86_64-unknown-linux-gnu

      - name: Install cross-compilation tools
        run: |
          sudo apt-get install -y gcc-arm-linux-gnueabihf gcc-aarch64-linux-gnu

      - name: Test build-all.sh --help
        run: |
          ./scripts/build-all.sh --help

      - name: Test build-release.sh (dry run)
        run: |
          # Just verify script runs without errors
          if ./scripts/build-release.sh v0.0.0-test 2>&1 | grep -q "Building"; then
            echo "build-release.sh execution started successfully"
          else
            echo "Error: build-release.sh failed to start"
            exit 1
          fi

  size-comparison:
    name: Binary Size Comparison
    runs-on: ubuntu-latest
    needs: build-native
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: armv7-unknown-linux-gnueabihf,aarch64-unknown-linux-gnu,x86_64-unknown-linux-gnu

      - name: Install cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-linux-gnueabihf gcc-aarch64-linux-gnu

      - name: Build all targets
        run: |
          cargo build --release --target armv7-unknown-linux-gnueabihf
          cargo build --release --target aarch64-unknown-linux-gnu
          cargo build --release --target x86_64-unknown-linux-gnu

      - name: Generate size report
        run: |
          echo "# Binary Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Size | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|--------|" >> $GITHUB_STEP_SUMMARY

          MAX_SIZE=$((10 * 1024 * 1024))  # 10MB

          for target in armv7-unknown-linux-gnueabihf aarch64-unknown-linux-gnu x86_64-unknown-linux-gnu; do
            BINARY="target/$target/release/picoflow"
            if [ -f "$BINARY" ]; then
              SIZE=$(stat -c%s "$BINARY")
              SIZE_MB=$(echo "scale=2; $SIZE / 1024 / 1024" | bc)

              if [ $SIZE -gt $MAX_SIZE ]; then
                STATUS="❌ Exceeds 10MB"
              else
                STATUS="✅ OK"
              fi

              echo "| $target | ${SIZE_MB}MB | $STATUS |" >> $GITHUB_STEP_SUMMARY
            fi
          done

  docker-build-all:
    name: Docker Build All Platforms
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Test docker-build.sh
        run: |
          chmod +x scripts/docker-build.sh
          ./scripts/docker-build.sh

      - name: Verify all binaries
        run: |
          echo "# Docker Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Size | Exists |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|--------|" >> $GITHUB_STEP_SUMMARY

          for platform in arm32 arm64 x86_64; do
            BINARY="target/release-binaries/picoflow-$platform"
            if [ -f "$BINARY" ]; then
              SIZE=$(stat -c%s "$BINARY")
              SIZE_MB=$(echo "scale=2; $SIZE / 1024 / 1024" | bc)
              echo "| $platform | ${SIZE_MB}MB | ✅ |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $platform | N/A | ❌ |" >> $GITHUB_STEP_SUMMARY
            fi
          done
